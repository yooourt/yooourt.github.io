<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EP</title>
<style>
* {
    box-sizing: border-box;
}

body {
    margin: 0;
}

ul,
ol {
    list-style-type: none;
    margin: 0;
    padding: 0;
}

#sound-list {
    padding: 20px 20px;
    height: calc(100vh - 250px);
    overflow: auto;
}

#sound-list li {
    height: 50px;
}

</style>
</head>
<body>
<!--
    0.
    1. 先用 audio 播放一个声音
    2. 选择一个歌曲然后播放
    3. 播放模式
    4. 生成列表
    5. 调用 github 查询接口，拿到列表信息
        https://api.github.com/repos/yooourt/yooourt.github.io/git/trees/main?recursive=0
-->
<ol id="sound-list">
</ol>

<audio id="player" controls></audio>

<script>
var ajax = function(request) {
    var xhr = new XMLHttpRequest()
    xhr.open(request.method, request.url, true)
    if (request.contentType !== undefined) {
        xhr.setRequestHeader('Content-Type', request.contentType)
    }
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            request.callback(xhr.response)
        }
    }

    xhr.send(request.data)
}

var e = document.querySelector.bind(document)

var on = function(element, selector, eventName, callback) {
    element.addEventListener(eventName, function(event) {
        var target = event.target
        if (target.matches(selector)) {
            callback(event)
        }
    })
}

var appendHtml = (element, html) => {
    element.insertAdjacentHTML('beforeend', html)
}

var generatePlayList = function(count) {
    var url = 'https://api.github.com/repos/yooourt/yooourt.github.io/git/trees/main?recursive=0'
    ajax({ method: 'GET', url: url, callback(json) {
        var data = JSON.parse(json)

        var list = data.tree
        for(var item of list) {
            var test  = (
                item.path.startsWith('ep') &&
                item.path.endsWith('.mp3') &&
                item.type === 'blob'
            )
            if (test) {
                var soundSrc = `.${item.path.slice(2)}`
                appendHtml(e('#sound-list'), `
                    <li data-sound-src="${soundSrc}">${soundSrc}</li>
                `)
            }
        }
    }})
}

var __main = function() {
    generatePlayList()
    on(e('#sound-list'), 'li', 'click', function(event) {
        var target = event.target
        var player = e('#player')
        player.src = target.dataset.soundSrc
        player.oncanplay = function() {
            player.play()
        }
    })
}

__main()
</script>
</body>
</html>
