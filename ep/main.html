<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EP</title>
<style>
* {
    box-sizing: border-box;
}

body {
    margin: 0;
}

ul,
ol {
    list-style-type: none;
    margin: 0;
    padding: 0;
}

#sound-list {
    padding: 20px 20px;
    height: calc(100vh - 250px);
    overflow: auto;
}

#sound-list li {
    height: 50px;
}

</style>
</head>
<body>
<ol id="sound-list">
</ol>

<dir id="current-sound">
</dir>

<audio id="player" controls></audio>

<script>
// 待实现的功能
// 1. 播放模式: 单曲循环，列表循环，随机播放
// 2. 功能按钮
//      2.1 前进10s
//      2.2 后退10s
// 3. 查看 pdf
// 4. 进度条
// 5. 当前时间，总时间
// 6. 暂停 开始
// 7. loading
var ajax = function(option) {
    return new Promise(function(resolve, reject) {
        var xhr = new XMLHttpRequest()

        xhr.open(option.method, option.url, true)

        if (option.contentType !== undefined) {
            xhr.setRequestHeader('Content-Type', option.contentType)
        }

        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                resolve(xhr.response)
            }
        }

        xhr.onerror = reject

        xhr.send(option.data)
    })
}

var e = document.querySelector.bind(document)

var on = function(element, selector, eventName, callback) {
    element.addEventListener(eventName, function(event) {
        var target = event.target
        if (target.matches(selector)) {
            callback(event)
        }
    })
}

var appendHtml = function(element, html) {
    element.insertAdjacentHTML('beforeend', html)
}

var generatePlayList = function(count) {
    var url = 'https://api.github.com/repos/yooourt/yooourt.github.io/git/trees/main?recursive=0'
    ajax({ method: 'GET', url: url })
        .then(function(json) {
            var data = JSON.parse(json)

            var list = data.tree
            for(var item of list) {
                var test  = (
                    item.path.startsWith('ep') &&
                    item.path.endsWith('.mp3') &&
                    item.type === 'blob'
                )
                if (test) {
                    var soundSrc = `.${item.path.slice(2)}`
                    appendHtml(e('#sound-list'), `
                        <li data-sound-src="${soundSrc}">${soundSrc}</li>
                    `)
                }
            }
        })
}

var __main = function() {
    generatePlayList()
    on(e('#sound-list'), 'li', 'click', function(event) {
        var target = event.target
        var player = e('#player')
        player.src = target.dataset.soundSrc
        player.oncanplay = function() {
            // 更新当前播放的音频名称
            e('#current-sound').innerHTML = target.dataset.soundSrc
            player.play()
        }
    })
}

__main()
</script>
</body>
</html>
