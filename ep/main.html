<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EP</title>
<style>
* {
    box-sizing: border-box;
}

body {
    margin: 0;
}

ul,
ol {
    list-style-type: none;
    margin: 0;
    padding: 0;
}

.play-list-wrapper {
    margin: 20px;
    outline: 1px solid #ccc;
}

#play-list {
    height: calc(100vh - 250px);
    overflow: auto;
}

#play-list li {
    display: flex;
    align-items: center;
    height: 50px;
    padding: 0 15px;
}

#play-list .directory {
    /* color: greenyellow; */
    font-weight: bolder;
}

#play-list .directory:not(:first-of-type) {
    margin-top: 50px;
}

#play-list .file {
    cursor: pointer;
}

#play-list .current-audio {
    background-color: #ddd;
}

#play-list .file:active {
  background-color: #aaa;
}

.player-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 250px;
}

</style>
</head>
<body>
<div class="play-list-wrapper">
    <ol id="play-list">
    </ol>
</div>

<div class="player-wrapper">
    <audio id="player" controls></audio>
</div>

<script type="text/javascript" src="./englishpod_data.js"></script>
<script>
// 待实现的功能
// 1. 播放模式: 单曲循环，列表循环，随机播放
// 2. 功能按钮
//      2.1 前进10s
//      2.2 后退10s
// 3. 查看 pdf
// 4. 进度条
// 5. 当前时间，总时间
// 6. 暂停 开始
// 7. loading
// 8. 相同的 要显示同一个颜色
let ajax = function(option) {
    return new Promise(function(resolve, reject) {
        let xhr = new XMLHttpRequest()

        xhr.open(option.method, option.url, true)

        if (option.contentType !== undefined) {
            xhr.setRequestHeader('Content-Type', option.contentType)
        }

        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                resolve(xhr.response)
            }
        }

        xhr.onerror = reject

        xhr.send(option.data)
    })
}

let e = document.querySelector.bind(document)
let ee = document.querySelectorAll.bind(document)

let on = function(element, selector, eventName, callback) {
    element.addEventListener(eventName, function(event) {
        let target = event.target
        if (target.matches(selector)) {
            callback(event)
        }
    })
}

let appendHtml = function(element, html) {
    element.insertAdjacentHTML('beforeend', html)
}

let playList = function(count) {
    let files = []
    for(let item of englishpodData) {
        if (item.type == 'directory') {
            let directory = item
            for(let dirent of item.dirents) {
                let name = dirent.name
                let test = (
                    dirent.type == 'file' &&
                    (
                        name.endsWith('.mp3') ||
                        name.endsWith('.pdf')
                    )
                )
                if (test) {
                    dirent.directoryName = directory.name
                    files.push(dirent)
                }
            }
        }
    }

    return files
}

let generatePlayList1 = function() {
    let previous
    let classes
    let list = playList()
    for(let item of list) {
        if (previous != item.directoryName) {
            if (classes == 'type1') {
                classes = 'type2'
            } else {
                classes = 'type1'
            }
        }
        previous = item.directoryName
        let soundSrc = item.path
        appendHtml(e('#play-list'), `
            <li class="${classes}" data-sound-src="${soundSrc}">${item.name}</li>
        `)
    }
}

let generatePlayList = function() {
    let prevDirName
    let list = playList()
    for(let item of list) {
        let currDirName = item.directoryName
        if (currDirName != prevDirName) {
            appendHtml(e('#play-list'), `
                <li class="directory">${currDirName}</li>
            `)
        }
        prevDirName = currDirName

        appendHtml(e('#play-list'), `
            <li class="file" data-sound-src="${item.path}">${item.name}</li>
        `)
    }
}

let highlightCurrent = function(current) {
    let elements = ee('#play-list .file').values()
    for(let el of elements) {
        let cls = 'current-audio'
        if (el == current) {
            el.classList.add(cls)
        } else {
            el.classList.remove(cls)
        }
    }
}

let bindEventSelectAudio = function() {
    let current = null
    on(e('#play-list'), '.file', 'click', function(event) {
        let target = event.target
        let player = e('#player')
        if (event.target != current) {
            current = event.target
            player.src = target.dataset.soundSrc
            highlightCurrent(current)
        }

        player.oncanplay = function() {
            player.play()
        }
    })
}



let __main = function() {
    generatePlayList()
    bindEventSelectAudio()
}

__main()
</script>
</body>
</html>
